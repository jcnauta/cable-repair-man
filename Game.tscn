[gd_scene load_steps=29 format=2]

[ext_resource path="res://CRM.tscn" type="PackedScene" id=1]
[ext_resource path="res://src/Network.gd" type="Script" id=2]
[ext_resource path="res://src/World.gd" type="Script" id=3]
[ext_resource path="res://images/node_white.png" type="Texture" id=4]
[ext_resource path="res://chary___.ttf" type="DynamicFontData" id=5]
[ext_resource path="res://src/Game.gd" type="Script" id=6]
[ext_resource path="res://LevelTimer.gd" type="Script" id=7]
[ext_resource path="res://retro_computer_personal_use.ttf" type="DynamicFontData" id=8]
[ext_resource path="res://Countdown.gd" type="Script" id=9]
[ext_resource path="res://sounds/place_cable.ogg" type="AudioStream" id=10]
[ext_resource path="res://images/spawn.png" type="Texture" id=11]
[ext_resource path="res://sounds/ready.ogg" type="AudioStream" id=12]
[ext_resource path="res://sounds/theme.ogg" type="AudioStream" id=13]
[ext_resource path="res://sounds/game_complete.ogg" type="AudioStream" id=14]
[ext_resource path="res://sounds/level_complete.ogg" type="AudioStream" id=15]
[ext_resource path="res://sounds/game_over.ogg" type="AudioStream" id=16]

[sub_resource type="SegmentShape2D" id=1]
b = Vector2( 480, 0 )

[sub_resource type="SegmentShape2D" id=2]
a = Vector2( 0, 288 )
b = Vector2( 480, 288 )

[sub_resource type="SegmentShape2D" id=3]
b = Vector2( 0, 288 )

[sub_resource type="SegmentShape2D" id=4]
a = Vector2( 480, 0 )
b = Vector2( 480, 288 )

[sub_resource type="DynamicFont" id=5]
font_data = ExtResource( 5 )

[sub_resource type="DynamicFont" id=6]
size = 64
font_data = ExtResource( 5 )

[sub_resource type="GDScript" id=7]
script/source = "extends Control

signal next_level
signal restart

onready var title = $VBoxContainer/LevelComplete
onready var score_label = $VBoxContainer/ScoreReport
onready var next_text = $VBoxContainer/Control/NextLevel

var timer
var level_complete = false

func _ready():
    set_process_input(false)

func show_score(level_score):
    visible = true
    level_complete = true
    var game_complete
    if Global.level_idx == len(Global.level_params) - 1:
        game_complete = true
    if game_complete:
        $game_complete.play()
        title.bbcode_text = \"[center]Game Complete[/center]\"
        score_label.bbcode_text = \"[center]Total time: \" + (\"%.2f\" % Global.total_score) + \"[/center]\"
        next_text.bbcode_text = \"[center]Press ENTER to set a higher score![/center]\"
    else:
        $level_complete.play()
        title.bbcode_text = \"[center]Level Complete[/center]\"
        score_label.bbcode_text = \"[center]Time: \" + (\"%.2f\" % level_score) + \"[/center]\"
        next_text.bbcode_text = \"[center]Press ENTER for level \" + str(Global.level_idx + 2) + \"[/center]\"
    accept_next(0.5)

func show_game_over():
    visible = true
    $game_over.play()
    level_complete = false
    title.bbcode_text = \"[center]Game Over[/center]\"
    if Global.crm.lives < 0:
        score_label.bbcode_text = \"[center]No More Lives[/center]\"
    else:
        score_label.bbcode_text = \"[center]Cannot connect All[/center]\"
    next_text.bbcode_text = \"[center]Press ENTER to restart[/center]\"
    accept_next()

# Protect user from themselves, throwing away an awesome highscore.
func accept_next(min_wait = 0.4):
    timer = Timer.new()
    self.add_child(timer)
    timer.wait_time = min_wait
    timer.connect(\"timeout\", self, \"accept_input\")
    timer.start()
    
func accept_input(do_accept = true):
    if timer != null and is_instance_valid(timer):
        timer.disconnect(\"timeout\", self, \"accept_input\")
        timer.queue_free()
        self.set_process_input(true)

func _input(event):
    if event.is_action_pressed(\"ui_accept\"):
        self.set_process_input(false)
        if level_complete:
            emit_signal(\"next_level\")
        else:
            emit_signal(\"restart\")
"

[sub_resource type="DynamicFont" id=8]
size = 14
font_data = ExtResource( 8 )

[sub_resource type="DynamicFont" id=9]
size = 14
font_data = ExtResource( 8 )

[sub_resource type="GDScript" id=10]
script/source = "extends RichTextLabel

var tween_alphas = [1.0, 0.0]
var tween_methods = [Tween.EASE_OUT, Tween.EASE_IN]
var tween

func _ready():
    tween = Tween.new()
    add_child(tween)
    tween.connect(\"tween_completed\", self, \"_on_tween_completed\")
    _start_blink()
    
func _start_blink():
    tween.interpolate_property(self, \"modulate\", \\
        Color(1.0, 0.0, 0.0, tween_alphas[0]), Color(0.0, 0.0, 1.0, tween_alphas[1]), 0.4, tween_methods[0])
    tween.start()

func _on_tween_completed(object, key):
    tween_alphas.invert()
    tween_methods.invert()
    _start_blink()
"

[sub_resource type="DynamicFont" id=11]
font_data = ExtResource( 5 )

[sub_resource type="GDScript" id=12]
script/source = "extends RichTextLabel


func set_lives(lives):
    bbcode_text = \"Lives: \" + str(max(0, Global.crm.lives))
"

[node name="Game" type="Node2D"]
script = ExtResource( 6 )

[node name="World" type="Node2D" parent="."]
script = ExtResource( 3 )

[node name="Network" type="Node2D" parent="World"]
script = ExtResource( 2 )

[node name="Edges" type="Node2D" parent="World/Network"]

[node name="Nodes" type="Node2D" parent="World/Network"]

[node name="Spawnpoint" type="Sprite" parent="World/Network"]
texture = ExtResource( 11 )
offset = Vector2( 0, 4 )

[node name="PlaceCable" type="AudioStreamPlayer" parent="World/Network"]
stream = ExtResource( 10 )

[node name="CRM" parent="World" instance=ExtResource( 1 )]

[node name="ScreenEdges" type="StaticBody2D" parent="World"]

[node name="top" type="CollisionShape2D" parent="World/ScreenEdges"]
shape = SubResource( 1 )

[node name="bottom" type="CollisionShape2D" parent="World/ScreenEdges"]
shape = SubResource( 2 )

[node name="left" type="CollisionShape2D" parent="World/ScreenEdges"]
shape = SubResource( 3 )

[node name="right" type="CollisionShape2D" parent="World/ScreenEdges"]
shape = SubResource( 4 )

[node name="UI" type="Control" parent="."]
anchor_right = 1.0
anchor_bottom = 1.0
margin_top = 0.463287
margin_right = 480.0
margin_bottom = 270.463
__meta__ = {
"_edit_use_anchors_": false
}

[node name="LevelTimer" type="RichTextLabel" parent="UI"]
anchor_right = 1.0
margin_right = 3.05176e-05
margin_bottom = 120.0
rect_min_size = Vector2( 480, 120 )
rect_clip_content = false
size_flags_horizontal = 3
custom_fonts/normal_font = SubResource( 5 )
bbcode_enabled = true
scroll_active = false
script = ExtResource( 7 )
__meta__ = {
"_edit_use_anchors_": false
}

[node name="Countdown" type="RichTextLabel" parent="UI"]
anchor_left = 0.5
anchor_top = 0.5
anchor_right = 0.5
anchor_bottom = 0.5
margin_left = -240.0
margin_top = -34.9999
margin_right = 240.0
margin_bottom = 65.0002
rect_min_size = Vector2( 480, 100 )
custom_fonts/normal_font = SubResource( 6 )
bbcode_enabled = true
bbcode_text = "[center]test[/center]"
text = "test"
script = ExtResource( 9 )
__meta__ = {
"_edit_use_anchors_": false
}

[node name="AudioStreamPlayer" type="AudioStreamPlayer" parent="UI/Countdown"]
stream = ExtResource( 12 )
volume_db = -9.087

[node name="EndLevelDialog" type="Control" parent="UI"]
visible = false
anchor_right = 1.0
anchor_bottom = 1.0
script = SubResource( 7 )
__meta__ = {
"_edit_use_anchors_": false
}

[node name="TextureRect" type="TextureRect" parent="UI/EndLevelDialog"]
modulate = Color( 1, 1, 1, 0.784314 )
anchor_left = 0.5
anchor_top = 0.5
anchor_right = 0.5
anchor_bottom = 0.5
margin_left = -150.0
margin_top = -50.0
margin_right = 150.0
margin_bottom = 50.0
rect_min_size = Vector2( 300, 100 )
texture = ExtResource( 4 )
expand = true
__meta__ = {
"_edit_use_anchors_": false
}

[node name="VBoxContainer" type="VBoxContainer" parent="UI/EndLevelDialog"]
anchor_right = 1.0
anchor_bottom = 1.0
margin_left = 90.0
margin_top = 85.0
margin_right = -90.0
margin_bottom = -84.9997
rect_min_size = Vector2( 300, 100 )
size_flags_horizontal = 0
size_flags_vertical = 0
__meta__ = {
"_edit_use_anchors_": false
}

[node name="Spacer" type="Control" parent="UI/EndLevelDialog/VBoxContainer"]
margin_right = 300.0
margin_bottom = 10.0
rect_min_size = Vector2( 0, 10 )

[node name="LevelComplete" type="RichTextLabel" parent="UI/EndLevelDialog/VBoxContainer"]
margin_top = 14.0
margin_right = 300.0
margin_bottom = 39.0
rect_min_size = Vector2( 200, 25 )
size_flags_vertical = 0
custom_fonts/normal_font = SubResource( 8 )
custom_colors/default_color = Color( 0, 0, 0, 1 )
bbcode_enabled = true
bbcode_text = "[center]Level Complete[/center]"
text = "Level Complete"
__meta__ = {
"_edit_use_anchors_": false
}

[node name="ScoreReport" type="RichTextLabel" parent="UI/EndLevelDialog/VBoxContainer"]
margin_top = 43.0
margin_right = 300.0
margin_bottom = 68.0
rect_min_size = Vector2( 0, 25 )
custom_fonts/normal_font = SubResource( 9 )
custom_colors/default_color = Color( 0, 0, 0, 1 )
bbcode_enabled = true
bbcode_text = "[center]Time: 14.79s[/center]"
text = "Time: 14.79s"

[node name="Control" type="Control" parent="UI/EndLevelDialog/VBoxContainer"]
margin_top = 72.0
margin_right = 300.0
margin_bottom = 97.0
rect_min_size = Vector2( 0, 25 )
__meta__ = {
"_edit_use_anchors_": false
}

[node name="NextLevel" type="RichTextLabel" parent="UI/EndLevelDialog/VBoxContainer/Control"]
margin_top = 4.0
margin_right = 600.0
margin_bottom = 29.0
rect_min_size = Vector2( 0, 25 )
rect_scale = Vector2( 0.5, 0.5 )
size_flags_horizontal = 3
custom_fonts/normal_font = SubResource( 9 )
custom_colors/default_color = Color( 0, 0, 0, 1 )
bbcode_enabled = true
bbcode_text = "[center]PRESS ENTER TO CONTINUE[/center]"
text = "PRESS ENTER TO CONTINUE"
script = SubResource( 10 )
__meta__ = {
"_edit_use_anchors_": false
}

[node name="Tween" type="Tween" parent="UI/EndLevelDialog/VBoxContainer/Control/NextLevel"]
repeat = true
playback/repeat = true

[node name="level_complete" type="AudioStreamPlayer" parent="UI/EndLevelDialog"]
stream = ExtResource( 15 )
volume_db = -7.0

[node name="game_complete" type="AudioStreamPlayer" parent="UI/EndLevelDialog"]
stream = ExtResource( 14 )
volume_db = -7.0

[node name="game_over" type="AudioStreamPlayer" parent="UI/EndLevelDialog"]
stream = ExtResource( 16 )
volume_db = -7.0

[node name="Lives" type="RichTextLabel" parent="UI"]
margin_right = 40.0
margin_bottom = 40.0
rect_min_size = Vector2( 100, 20 )
custom_fonts/normal_font = SubResource( 11 )
bbcode_enabled = true
script = SubResource( 12 )
__meta__ = {
"_edit_use_anchors_": false
}

[node name="BgMusic" type="AudioStreamPlayer" parent="."]
stream = ExtResource( 13 )
volume_db = -16.155
autoplay = true
